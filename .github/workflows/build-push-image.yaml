name: Build & Push Docker Image

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch or tag to build (e.g. feature/xyz or v1.2.3). Leave empty to use the branch you trigger from."
        required: false
      push_image:
        description: "Push image? (true/false)"
        required: false
        default: "true"

permissions:
  contents: read
  packages: write

concurrency:
  group: build-docker-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}
  DOCKER_BUILDKIT: 1

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve ref
        id: ref
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.ref }}" ]; then
            echo "REF=${{ github.event.inputs.ref }}" >> $GITHUB_OUTPUT
          else
            echo "REF=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.ref.outputs.REF }}
          fetch-depth: 0

      - name: Enable Corepack / pnpm
        run: corepack enable

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build Angular
        run: pnpm run build:github

      - name: Verify dist
        run: |
          if [ -z "$(find dist -type f -maxdepth 3 -print -quit 2>/dev/null)" ]; then
            echo "dist empty"; exit 1; fi
          echo "dist OK"

      - name: Compute tags
        id: tags
        run: |
          set -euo pipefail
          REF='${{ steps.ref.outputs.REF }}'
          SHORT_SHA=$(echo '${{ github.sha }}' | cut -c1-7)
          sanitize() { echo "$1" | tr '/_' '-' | tr -cd '[:alnum:]-' | sed 's/^-*//;s/-*$//' | cut -c1-60; }
          TAGS=""
          if [ "${{ github.event_name }}" = "push" ] && [ "${GITHUB_REF_TYPE}" = "branch" ] && [ "$REF" = "main" ]; then
            TAGS="${IMAGE_NAME}:latest ${IMAGE_NAME}:main-${SHORT_SHA}"
          elif [ "${{ github.event_name }}" = "push" ] && [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            RAW="$REF"
            STRIPPED=$(echo "$RAW" | sed 's/^v//')
            TAGS="${IMAGE_NAME}:$RAW ${IMAGE_NAME}:$STRIPPED ${IMAGE_NAME}:latest"
          else
            # Manual or non-main branch
            if echo "$REF" | grep -qE '^v[0-9]'; then
              RAW="$REF"
              STRIPPED=$(echo "$RAW" | sed 's/^v//')
              TAGS="${IMAGE_NAME}:$RAW ${IMAGE_NAME}:$STRIPPED ${IMAGE_NAME}:latest"
            else
              SAFE=$(sanitize "$REF")
              TAGS="${IMAGE_NAME}:$SAFE-${SHORT_SHA}"
            fi
          fi
          echo "TAG_LIST=$TAGS" >> $GITHUB_OUTPUT
          echo "Tags: $TAGS"

      - name: Login GHCR
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.push_image == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image
        run: |
          ARGS=""
          for t in ${{ steps.tags.outputs.TAG_LIST }}; do ARGS="$ARGS -t $t"; done
          echo "docker build $ARGS ."
          docker build $ARGS .

      - name: Push image(s)
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.push_image == 'true' }}
        run: |
          for t in ${{ steps.tags.outputs.TAG_LIST }}; do
            echo "Pushing $t"
            docker push "$t"
          done

      - name: Summary
        run: echo "Final tags: ${{ steps.tags.outputs.TAG_LIST }}"
